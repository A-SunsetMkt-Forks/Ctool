var j=Object.defineProperty;var z=(n,e,t)=>e in n?j(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e,t)=>(z(n,typeof e!="symbol"?e+"":e,t),t);import{J as T}from"./index-da14ef80.js";const d="google/protobuf/any.proto",N="google/protobuf/timestamp.proto",c="google.protobuf.Any",y="google.protobuf.Timestamp";class g{constructor(e,t){this.success=e,this.error=t}}class m{constructor(e,t,s){this.name=e,this.complex=t,this.merge=s}}const w=new m("bool",!1,!1),S=new m("string",!1,!1),x=new m("int64",!1,!0),O=new m(c,!0,!1),$=new m(y,!1,!1);class U{constructor(e,t,s){this.inline=e,this.googleProtobufTimestamp=t,this.mergeSimilarObjects=s}}class l{constructor(){f(this,"imports");f(this,"messages");f(this,"messageNameSuffixCounter");this.imports=new Set,this.messages=[],this.messageNameSuffixCounter={}}addImport(e){this.imports.add(e)}generateUniqueName(e){if(this.messageNameSuffixCounter.hasOwnProperty(e)){const t=this.messageNameSuffixCounter[e];return this.messageNameSuffixCounter[e]=t+1,`${e}${t}`}return this.messageNameSuffixCounter[e]=1,e}addMessage(e){this.messages.push(e)}getImports(){return this.imports}getMessages(){return this.messages}}class A{constructor(e){f(this,"mergeSimilarObjectMap",{});this.options=e}analyze(e){return this.directType(e)?this.analyzeObject({first:e}):Array.isArray(e)?this.analyzeArray(e):this.analyzeObject(e)}directType(e){switch(typeof e){case"string":case"number":case"boolean":return!0;case"object":return e===null}return!1}analyzeArray(e){const t=this.addShift(),s=new l,r=[],i=this.analyzeArrayProperty("nested",e,s,t);return r.push(`    ${i} items = 1;`),P(s.getImports(),s.getMessages(),r,this.options)}analyzeObject(e){const t=this.addShift(),s=new l,r=[];let i=1;for(const[o,a]of Object.entries(e)){const u=this.analyzeProperty(o,a,s,t);r.push(`    ${u} ${o} = ${i};`),i+=1}return P(s.getImports(),s.getMessages(),r,this.options)}analyzeArrayProperty(e,t,s,r){const i=t.length;if(i===0)return s.addImport(d),`repeated ${c}`;const o=t[0];if(Array.isArray(o))return s.addImport(d),`repeated ${c}`;if(i>1){const a=this.samePrimitiveType(t);if(!a.complex)return`repeated ${a.name}`}return`repeated ${this.analyzeObjectProperty(e,o,s,r)}`}analyzeProperty(e,t,s,r){return Array.isArray(t)?this.analyzeArrayProperty(e,t,s,r):this.analyzeObjectProperty(e,t,s,r)}analyzeObjectProperty(e,t,s,r){const i=this.analyzeType(t,s);if(i==="object"){if(this.options.mergeSimilarObjects){const[a,u]=this.mergeSimilarObjectKey(t);if(u){if(this.mergeSimilarObjectMap.hasOwnProperty(a))return this.mergeSimilarObjectMap[a];const p=s.generateUniqueName(b(e));return this.mergeSimilarObjectMap[a]=p,this.addNested(s,p,t,r),p}}const o=s.generateUniqueName(b(e));return this.addNested(s,o,t,r),o}return i}mergeSimilarObjectKey(e){const t=[];for(const[s,r]of Object.entries(e)){const[i,o]=this.mergeSimilarObjectType(r);if(o)t.push([s,i]);else return["",!1]}return[T.stringify(t),!0]}mergeSimilarObjectType(e){if(Array.isArray(e))return["",!1];switch(typeof e){case"string":return this.options.googleProtobufTimestamp&&/\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(\+\d\d:\d\d|Z)/.test(e)?[y,!0]:["string",!0];case"number":case"bigint":return[h(e),!0];case"boolean":return["bool",!0]}return["",!1]}analyzeType(e,t){switch(typeof e){case"string":return this.options.googleProtobufTimestamp&&/\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(\+\d\d:\d\d|Z)/.test(e)?(t.addImport(N),y):"string";case"number":case"bigint":return h(e);case"boolean":return"bool";case"object":return e===null?(t.addImport(d),c):"object"}return t.addImport(d),c}toPrimitiveType(e){switch(typeof e){case"string":return this.options.googleProtobufTimestamp&&/\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(\.\d+)?(\+\d\d:\d\d|Z)/.test(e)?$:S;case"number":case"bigint":return new m(h(e),!1,!0);case"boolean":return w}return O}samePrimitiveType(e){let t=this.toPrimitiveType(e[0]);if(t.complex)return t;for(let s=1;s<e.length;s++){const r=this.toPrimitiveType(e[s]);if(r.complex)return r;if(t=M(t,r),t.complex)return t}return t}addNested(e,t,s,r){const i=[];i.push(`${r}message ${t} {`);let o=1;for(const[a,u]of Object.entries(s)){const p=this.analyzeProperty(a,u,e,r);i.push(`${r}    ${p} ${a} = ${o};`),o+=1}i.push(`${r}}`),e.addMessage(i)}addShift(){return this.options.inline?"    ":""}}function q(n,e){if(n==="")return new g("","");const t=n.replace(/\.0/g,".1");try{const s=T.parse(t),r=new A(e);return new g(r.analyze(s),"")}catch(s){return new g("",$error(s))}}function b(n){return n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()}function P(n,e,t,s){const r=[];if(r.push('syntax = "proto3";'),n.size>0){r.push("");for(const i of n)r.push(`import "${i}";`)}if(r.push(""),s.inline){if(r.push("message SomeMessage {"),e.length>0){r.push("");for(const i of e)r.push(...i),r.push("")}r.push(...t),r.push("}")}else{for(const i of e)r.push(...i),r.push("");r.push("message SomeMessage {"),r.push(...t),r.push("}")}return r.join(`
`)}function M(n,e){if(n.name===e.name)return n;if(n.merge&&e.merge){if(n.name==="double")return n;if(e.name==="double")return e;if(n.name==="int64")return n;if(e.name==="int64")return e;if(n.name==="uint64"){if(e.name==="uint32")return n}else if(e.name==="uint64"&&n.name==="uint32")return e;return x}return O}function h(n){return typeof n=="bigint"?"int64":n%1===0?n<0?n<-2147483648?"int64":"int32":n>4294967295?"uint64":"uint32":"double"}export{U as Options,q as convert};
