name: Build Ctool
on: [ push ]
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Build Core
        run: | 
          pnpm run build
          ls -lh ./packages/ctool-core/dist

      - name: Release Adapter Platform
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          pnpm run only-release
          ls -lh ./_release/

      - name: Upload Release To Github
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: true
          files: |
            ./_release/ctool_web.zip
            ./_release/ctool_chrome.zip
            ./_release/ctool_edge.zip
            ./_release/ctool_utools.zip
            ./_release/ctool_firefox.zip
            ./_release/ctool_electron_linux_x64.tar.gz
            ./_release/ctool_electron_mac_arm64.zip
            ./_release/ctool_electron_mac_x64.zip
            ./_release/ctool_electron_win_x64.zip

      - name: Deploy web to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_dir: ./packages/ctool-core/dist
